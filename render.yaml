services:
  - type: web
    name: knowthyself-web
    runtime: python
    buildCommand: |
      pip install -r requirements.txt &&
      npm ci &&
      npm run build &&
      python manage.py collectstatic --noinput
    startCommand: python manage.py migrate && gunicorn knowthyself.wsgi:application --bind 0.0.0.0:$PORT --workers 2 --threads 2 --timeout 120
    plan: free
    healthCheckPath: /

    envVars:
      - fromGroup: app-env
      - key: POSTGRES_DB
        fromDatabase:
          name: knowthyself-db
          property: database
      - key: POSTGRES_USER
        fromDatabase:
          name: knowthyself-db
          property: user
      - key: POSTGRES_PASSWORD
        fromDatabase:
          name: knowthyself-db
          property: password
      - key: POSTGRES_HOST
        fromDatabase:
          name: knowthyself-db
          property: host
      - key: POSTGRES_PORT
        fromDatabase:
          name: knowthyself-db
          property: port
      - key: REDIS_HOST
        fromService:
          type: keyvalue
          name: knowthyself-redis
          property: host
      - key: REDIS_PORT
        fromService:
          type: keyvalue
          name: knowthyself-redis
          property: port
      - key: REDIS_PASSWORD
        fromService:
          type: keyvalue
          name: knowthyself-redis
          property: password

  - type: web
    name: knowthyself-workers
    runtime: python
    buildCommand: |
      pip install -r requirements.txt
    startCommand: python manage.py qcluster & python -m http.server $PORT
    plan: free
    healthCheckPath: /

    envVars:
      - fromGroup: app-env
      - key: POSTGRES_DB
        fromDatabase:
          name: knowthyself-db
          property: database
      - key: POSTGRES_USER
        fromDatabase:
          name: knowthyself-db
          property: user
      - key: POSTGRES_PASSWORD
        fromDatabase:
          name: knowthyself-db
          property: password
      - key: POSTGRES_HOST
        fromDatabase:
          name: knowthyself-db
          property: host
      - key: POSTGRES_PORT
        fromDatabase:
          name: knowthyself-db
          property: port
      - key: REDIS_HOST
        fromService:
          type: keyvalue
          name: knowthyself-redis
          property: host
      - key: REDIS_PORT
        fromService:
          type: keyvalue
          name: knowthyself-redis
          property: port
      - key: REDIS_PASSWORD
        fromService:
          type: keyvalue
          name: knowthyself-redis
          property: password

  - type: keyvalue
    name: knowthyself-redis
    plan: free
    ipAllowList: []
    maxmemoryPolicy: allkeys-lfu

databases:
  - name: knowthyself-db
    databaseName: knowthyself
    user: knowthyself_user
    plan: free


envVarGroups:
  - name: app-env
    envVars:
      - key: PYTHON_VERSION
        value: "3.11.6"
      - key: ENVIRONMENT
        value: prod
      - key: DEBUG
        value: "False"
      - key: SECRET_KEY
        generateValue: true

      # Site URL - auto-generated by Render
      - key: SITE_URL
        value: $RENDER_EXTERNAL_URL

      
      # Optional. If not specified, local FileSystemStorage is used for media files.
      - key: AWS_S3_ENDPOINT_URL
        value: ""
      - key: AWS_ACCESS_KEY_ID
        value: ""
      - key: AWS_SECRET_ACCESS_KEY
        value: ""
      

      # Basic email setup - can be configured later
      - key: MAILGUN_API_KEY
        value: ""

      # Redis Database Number
      - key: REDIS_DB
        value: "0"
